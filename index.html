<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Math</title>
    <style>
        body {
            margin: 0;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            background-color: #000000;
        }

        #top {
            display: flex;
            gap: 50px;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%
        }

        #center {
            max-width: 572px;
            width: 100%;
            height: 242px;
            overflow-x: auto;
            display: flex;
            justify-content: center;
        }

        #button {
            display: inline-block;
            width: 50px;
            height: 50px;
            cursor: default;
            -webkit-user-select: none;
            -moz-user-select: none;
            user-select: none;
        }

        #label {
            color: #FFFFFF;
            font-size: 16px;
            font-family: Menlo, monospace;
            line-height: 50px;
            flex-grow: 1;
            -webkit-user-select: none;
            -moz-user-select: none;
            user-select: none;
        }

        #input {
            color: #000000;
            font-size: 16px;
            font-family: Menlo, monospace;
            line-height: 50px;
            background-color: #000000;
            border: none;
            padding: 0;
            margin: 0;
            outline: none;
            flex-grow: 1;
        }

        #input:focus {
            color: #FFFFFF;
        }

        #soroban {
            display: flex;
            align-items: center;
            position: relative;
            width: 572px;
            height: 234px;
            border-top: 4px solid #808080;
            border-bottom: 4px solid #808080;
        }

        .bar {
            position: absolute;
            top: 64px;
            left: 0;
            right: 0;
            height: 4px;
            background-color: #808080;
        }

        .rod {
            width: 4px;
            height: 234px;
            background-color: #808080;
            margin: 0 20px;
            position: relative;
        }

        .bead {
            width: 30px;
            height: 30px;
            background-color: #FFFFFF;
            position: absolute;
            left: -13px;
        }

        .bead:nth-of-type(1) {
            top: 0px;
        }

        .bead:nth-of-type(2) {
            bottom: 102px;
        }

        .bead:nth-of-type(3) {
            bottom: 68px;
        }

        .bead:nth-of-type(4) {
            bottom: 34px;
        }

        .bead:nth-of-type(5) {
            bottom: 0px;
        }

        .bead.active:nth-of-type(1) {
            transform: translateY(34px);
        }

        .bead.active {
            transform: translateY(-34px);
        }
    </style>
</head>

<body>
    <div id="top">
        <div id="button"></div>
        <label id="label" style="display: none;"></label>
        <input type="text" id="input" style="display: none;">
    </div>
    <div id="center">
        <div id="soroban">
            <div class="bar"></div>
        </div>
    </div>
    <script>
        let mode = 1;
        let answer;
        let interval;
        const div_label = document.getElementById("label");
        const div_input = document.getElementById("input");
        window.onload = create_soroban;
        document.onmousedown = reset_soroban;
        document.getElementById("button").onclick = next_mode;
        div_label.onmousedown = next_problem;
        div_input.onfocus = reset_anzan;
        div_input.onblur = next_anzan;
        function create_soroban() {
            const soroban = document.getElementById("soroban");
            for (let i = 0; i < 13; i++) {
                const rod = document.createElement("div");
                rod.className = "rod";
                for (let j = 0; j < 5; j++) {
                    const bead = document.createElement("div");
                    bead.className = "bead";
                    if (j === 1 && (i % 3 === 1)) {
                        bead.style.backgroundColor = "#FF0000";
                    }
                    bead.onmousedown = () => {
                        let beads = [...bead.parentElement.children];
                        let index = beads.indexOf(bead);
                        if (index === 0) {
                            bead.classList.toggle("active");
                        } else if (bead.classList.contains("active")) {
                            for (; index < 5; index++) {
                                beads[index].classList.remove("active");
                            }
                        } else {
                            for (; index > 0; index--) {
                                beads[index].classList.add("active");
                            }
                        }
                    }
                    rod.appendChild(bead);
                }
                soroban.appendChild(rod);
            }
        }
        function create_anzan() {
            reset_anzan();
            let sum = 0;
            let num = Math.floor(Math.random() * 99) + 1;
            let string = "1000 10";
            for (let i = 0; i < 10; i++) {
                sum += num;
                string = string + " " + sum;
            }
            for (let i = 0; i < 10; i++) {
                sum -= num;
                string = string + " " + sum;
            }
            div_input.value = string;
            next_anzan();
        }
        function reset_soroban() {
            if (mode === 3) {
                return;
            }
            const top = document.getElementById("top");
            const center = document.getElementById("center");
            if (!top.contains(event.target) && !center.contains(event.target)) {
                document.querySelectorAll(".bead").forEach((bead) => {
                    bead.classList.remove("active");
                });
            }
        }
        function reset_anzan() {
            clearInterval(interval);
            document.querySelectorAll(".bead").forEach((bead) => {
                bead.classList.remove("active");
            });
        }
        function next_mode() {
            mode = (mode % 3) + 1;
            if (mode === 1) {
                document.getElementById("input").style.display = "none";
                reset_anzan();
            } else if (mode === 2) {
                document.getElementById("label").style.display = "block";
                next_problem();
            } else if (mode === 3) {
                document.getElementById("label").style.display = "none";
                document.getElementById("input").style.display = "block";
                create_anzan();
            }
        }
        function next_problem() {
            document.querySelectorAll(".bead").forEach((bead) => {
                bead.classList.remove("active");
            });
            const operation = Math.floor(Math.random() * 4);
            if (operation === 0) {
                let num1 = Math.floor(Math.random() * 999999) + 1;
                let num2 = Math.floor(Math.random() * 999999) + 1;
                answer = num1 + num2;
                div_label.textContent = num1 + " + " + num2 + " = " + answer;
            } else if (operation === 1) {
                let num1 = Math.floor(Math.random() * 999999) + 1;
                let num2 = Math.floor(Math.random() * 999999) + 1;
                [num1, num2] = [Math.max(num1, num2), Math.min(num1, num2)];
                answer = num1 - num2;
                div_label.textContent = num1 + " - " + num2 + " = " + answer;
            } else if (operation === 2) {
                let num1 = Math.floor(Math.random() * 99) + 1;
                let num2 = Math.floor(Math.random() * 999) + 1;
                answer = num1 * num2;
                div_label.textContent = num1 + " * " + num2 + " = " + answer;
            } else if (operation === 3) {
                let num1 = Math.floor(Math.random() * 999999) + 1;
                let num2 = Math.floor(Math.random() * 999) + 1;
                answer = num1 / num2;
                div_label.textContent = num1 + " / " + num2 + " = " + answer.toFixed(2);
            }
        }
        function next_anzan() {
            let index = 0;
            let nums = div_input.value.split(" ");
            const delay = nums.shift();
            const position = nums.shift();
            const rods = document.getElementsByClassName("rod");
            clearInterval(interval);
            interval = setInterval(() => {
                document.querySelectorAll(".bead").forEach((bead) => {
                    bead.classList.remove("active");
                });
                let num = nums[index];
                let n_digits = num.length;
                for (let i = 0; i < n_digits; i++) {
                    let beads = [...rods[position - n_digits + i + 1].children];
                    let n = Math.floor(num[i] / 5);
                    if (n === 1) {
                        beads[0].onmousedown();
                    }
                    n = num[i] % 5;
                    if (n > 0) {
                        beads[n].onmousedown();
                    }
                }
                index = (index + 1) % nums.length;
            }, delay);
        }
    </script>
</body>

</html>